<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<style>
#wrapper {
  display: flex;
  flex-direction: column;
  .sourceBox {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 550px;
    .showImageBox {
      position: absolute;
      border: 1px solid red;
    }
    .dragBox {
      position: absolute;
      border: 1px solid green;
    }
  }
  .targetBox {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    .showClipAreaBox {
      border: 1px solid yellowgreen;
    }
  }
}
</style>
<body>
<div id="wrapper">
  <label for="fileOption"><input type="file" id="fileOption"></label>
  <div class="sourceBox">
    <canvas class="showImageBox"></canvas>
    <canvas class="dragBox"></canvas>
  </div>
  <div class="targetBox">
    <canvas class="showClipAreaBox"></canvas>
  </div>
</div>
<script>
;(() => {
  const sourceBox = document.querySelector('.sourceBox');
  const showImageBox = document.querySelector('.showImageBox');
  const dragBox = document.querySelector('.dragBox');
  const showClipArea = document.querySelector('.showClipAreaBox');

  dragBox.addEventListener('dragover', function (e) {
    e.stopPropagation();
    e.preventDefault();
  });
  dragBox.addEventListener('drop', handleDrop);
  function handleDrop(e) {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    const readFile = new FileReader();
    readFile.readAsDataURL(file);
    readFile.addEventListener('load', handleLoad);
    function handleLoad(e) {
      const img = new Image();
      img.src = this.result;
      img.addEventListener('load', handleInnerLoad);
      function handleInnerLoad(e) {
        const naturalWid = this.width;
        const naturalHei = this.height;
        sourceBox.width = naturalWid;
        sourceBox.height = naturalHei;
        showImageBox.width = naturalWid;
        showImageBox.height = naturalHei;
        dragBox.width = naturalWid;
        dragBox.height = naturalHei;

        const showImageCtx = showImageBox.getContext('2d');
        showImageCtx.drawImage(this, 0, 0, showImageBox.width, showImageBox.height);

        // 设置蒙层
        setLayer(dragBox);
      }
    }

    let startShot = false;
    let startX, startY, targetX, targetY, targetWid, targetHei;
    dragBox.addEventListener('mousedown', handleMousedown);
    dragBox.addEventListener('mousemove', handleMousemove);
    dragBox.addEventListener('mouseup', handleMouseup);
    function handleMousedown(e) {
      startX = e.offsetX;
      startY = e.offsetY;
      console.log('down', startShot);
      startShot = true;
    }
    function handleMousemove(e) {
      console.log(startShot);
      if (!startShot) return;
      const moveX = e.offsetX;
      const moveY = e.offsetY;
      targetX = Math.min(moveX, startX);
      targetY = Math.min(moveY, startY);
      targetWid = Math.abs(moveX - startX);
      targetHei = Math.abs(moveY - startY);
      const ctx = dragBox.getContext('2d');
      ctx.clearRect(0, 0, dragBox.width, dragBox.height);
      setLayer(dragBox);
      ctx.strokeStyle = 'red';
      ctx.strokeRect(targetX - ctx.lineWidth, targetY - ctx.lineWidth, targetWid + 2*ctx.lineWidth, targetHei + 2*ctx.lineWidth);
      ctx.save();
      ctx.globalCompositeOperation = 'destination-out';
      ctx.fillRect(targetX, targetY, targetWid, targetHei);
      ctx.restore();
    }
    function handleMouseup(e) {
      console.log('up', startShot);
      startShot = false;
      drawShot(dragBox, showClipArea);
      const ctx = dragBox.getContext('2d');
      ctx.clearRect(0, 0, dragBox.width, dragBox.height);
    }
    function setLayer(dragBox) {
      const ctx = dragBox.getContext('2d');
      ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
      ctx.fillRect(0, 0, dragBox.width, dragBox.height);
    }

    function drawShot(dragBox, showClipArea) {
      showClipArea.width = targetWid;
      showClipArea.height = targetHei;
      const ctx = showClipArea.getContext('2d');
      ctx.drawImage(showImageBox, targetX, targetY, targetWid, targetHei, 0, 0, showClipArea.width, showClipArea.height);
    }
  }
  
})();
</script>
</body>
</html>