<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<style>
.wrapper {
  display: flex;
  flex-direction: row;
  justify-content: flex-start;
  .dragBox {
    border: 1px solid red;
    justify-content: center;
    align-items: center;
  }
}
.container {
  width: 100%;
  .screenshotBox {
    display: block;
    border: 1px solid blue;
    margin: 30px auto;
  }
}
</style>
<body>
  <div class="wrapper">
    <label for="readFile"><input type="file" id="readFile" accept="image/*"></label>
    <span>拖放图片放置到这个区域</span>
    <canvas class="dragBox"></canvas>
  </div>
  <div class="container"><canvas class="screenshotBox"></canvas></div>

  <script>
    const readFile = document.querySelector('#readFile');
    const dragBox = document.querySelector('.dragBox');
    const screenshotBox = document.querySelector('.screenshotBox');
    const img = new Image();

    dragBox.addEventListener('dragover', function (e) {
      e.stopPropagation();
      e.preventDefault();
    });

    dragBox.addEventListener('drop', handleFile);
    function handleFile(e) {
      e.preventDefault();
      e.stopPropagation();
      const file = e.dataTransfer.files[0];
      if (!file.type.startsWith('image')) return;
      const fileReader = new FileReader();
      fileReader.readAsDataURL(file);
      fileReader.addEventListener('load', () => {
        img.src = fileReader.result;
        img.addEventListener('load', () => {
          dragBox.width = img.width;
          dragBox.height = img.height;
          console.log(img.width, img.height);
          const ctx = dragBox.getContext('2d');
          ctx.drawImage(img, 0, 0, dragBox.width, dragBox.height);
        });
      });
    }

    dragBox.addEventListener('mousedown', handleMousedown);
    dragBox.addEventListener('mousemove', handleMousemove);
    dragBox.addEventListener('mouseup', handleMouseup);
    dragBox.addEventListener('mouseleave', handleMouseleave);
    let startX, startY, sX, sY, screenshotWid, screenshotHei;
    let startCutout = false;
    function handleMousedown(e) {
      startX = e.offsetX;
      startY = e.offsetY;
      console.log(startX, startY);
      startCutout = true;
    }

    function handleMousemove(e) {
      if (startCutout) {
        const endX = e.offsetX;
        const endY = e.offsetY;
        sX = Math.min(endX, startX);
        sY = Math.min(endY, startY);
        screenshotWid = Math.abs(startX - endX);
        screenshotHei = Math.abs(startY - endY);
        const ctx = dragBox.getContext('2d');
        requestAnimationFrame(() => {
          ctx.clearRect(0, 0, ctx.width, ctx.height);
          ctx.strokeStyle = 'red';
          ctx.lineWidth = 1;
          ctx.drawImage(img, 0, 0);
          ctx.strokeRect(sX, sY, screenshotWid, screenshotHei);
        });
      }
    }

    function handleMouseup(e) {
      startCutout = false;
      screenshot();
    }

    function handleMouseleave(e) {
      const ctx = dragBox.getContext('2d');
      ctx.clearRect(0, 0, ctx.width, ctx.height);
      ctx.drawImage(img, 0, 0);
      startCutout = false;
    }

    function screenshot() {
      const ctx = dragBox.getContext('2d');
      ctx.clearRect(0, 0, ctx.width, ctx.height);
      ctx.drawImage(img, 0, 0);

      const screenshotBox = document.querySelector('.screenshotBox');
      screenshotBox.width = screenshotWid;
      screenshotBox.height = screenshotHei;
      const sCtx = screenshotBox.getContext('2d');
      sCtx.drawImage(dragBox, sX, sY, screenshotWid, screenshotHei, 0, 0, screenshotWid, screenshotHei);
    }

  </script>
</body>
</html>